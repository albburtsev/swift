/*!
 * Swift Map Library v0.0.1
 * https://github.com/albburtsev/swift
 * 
 * Copyright 2012, Alexander Burtsev
 * Licensed under the MIT
 * Date: Tue Jul 17 2012 00:36:11 GMT+0400 (MSD)
 */
(function(a,b,c){function d(){}function i(){if(this instanceof i)this.message="Invalid arguments";else return new i}function j(){}function k(a,b){if(!(this instanceof k))return new k(a,b);if(a===c||b===c)throw i();this.width(a),this.height(b)}function l(a,b){if(!(this instanceof l))return new l(a,b);if(a===c||b===c)throw i();this.lon(a),this.lat(b)}function m(a,b){if(!(this instanceof m))return new m(a,b);if(a===c||b===c)throw i();this.x(a),this.y(b)}function n(a,b,c,d){if(this instanceof n)e.mixin(this,{tx:a,ty:b,tz:c},d),this.tnx=e.or(this.tnx,this.tx),this.tny=e.or(this.tny,this.ty);else return new n(a,b,c,d)}function o(a){if(this instanceof o)this.radius=6378137,this.halfEquator=Math.PI*this.radius,this.equator=2*this.halfEquator,this.tileSize=k(256,256),e.extend(this,a||{});else return new o}function p(){}function q(a,b){if(!(this instanceof q))return new q(a,b);b=b||{};if(!a)throw i();e.mixin(this,{name:"",opacity:1,tileSize:this.defaultTileSize,url:a,z:this.defaultZ,zoomShift:0},b),this._node=f.absDiv(h.get("tiles-layer"),{zIndex:this.z,left:0,top:0,opacity:this.opacity}),this.update()}function r(a,c){if(!(this instanceof r))return new r(a,c);c=c||{},a=a||{},e.reprop(c,"center").reprop(c,"zoom").reprop(c,"prj").mixin(this,{__layers:[],__prj:o(),__rp:null,__vp:null,background:this.defaultBackground},c),this.zoom(e.or(c.__zoom,this.defaultZoom)),this.center(c.__center||this.defaultCenter),typeof a=="string"&&(a=b.getElementById(a));if(a.nodeType!==1)throw i();var d=e.computed(a,"position");f.css(a,{background:this.background,position:d==="static"?"relative":d,overflow:"hidden"}),this._node=a,this.vp(!0),this.rp(!0),e.mixin(this,{_layers:f.absDiv(h.get("layers-holder")),_tiles:f.absDiv(h.get("tiles-holder")),_vector:f.absDiv(h.get("vector-holder")),_markers:f.absDiv(h.get("marker-holder"))}),this._layers.appendChild(this._tiles),this._layers.appendChild(this._vector),this._layers.appendChild(this._markers),this._node.appendChild(this._layers),this.add(q("http://api.tiles.mapbox.com/v3/mapbox.mapbox-streets/${z}/${x}/${y}.png"))}"use strict";var e={async:function(b,c){return setTimeout(function(){b.call(c||a)},1),this},computed:function(b,c){if(!a.getComputedStyle){var d=function(a){var b=/(\-([a-z]){1})/g;return this.el=a,this.getPropertyValue=function(c){return c=="float"&&(c="styleFloat"),b.test(c)&&(c=c.replace(b,function(a,b,c){return c.toUpperCase()})),a.currentStyle[c]?a.currentStyle[c]:null},this};a.getComputedStyle=d}return getComputedStyle(b).getPropertyValue(c)},each:function(a,b){a=a||{},b=b||d;for(var c in a)a.hasOwnProperty(c)&&b.call(this,c,a[c])},extend:function(a,b,c){function d(){}return d.prototype=a.prototype,b.prototype=new d,b.prototype.constructor=b,this.mixin(b.prototype,c),this},mixin:function(){var a=arguments[0],b,c;if(arguments.length<=1)return a;for(b=1;b<arguments.length;b++)for(c in arguments[b])arguments[b].hasOwnProperty(c)&&(a[c]=arguments[b][c]);return a},or:function(){for(var a=0;a<arguments.length;a++)if(arguments[a]!==c)return arguments[a]},reprop:function(a,b){return a[b]!==c&&(a["__"+b]=a[b],delete a[b]),this},tmpl:function(a,b){var d="",e;b=b instanceof Array?b:[b];for(e=0;e<b.length;e++)d+=a.replace(/\$\{(\w+)\}/ig,function(a,d){return b[e][d]===c?"":b[e][d]});return d}},f={absDiv:function(a,b){return b=e.mixin({position:"absolute",left:0,top:0},b||{}),this.node("",a?{"class":a}:{},b)},attr:function(a,c){return e.each(c||{},function(c,d){if(c.match(/^on/))a[c]=d;else{var e=b.createAttribute(c);e.value=d,a.setAttributeNode(e)}}),this},css:function(a,b){return e.each(b||{},function(b,c){a.style[b]=c}),this},node:function(a,c,d){var e=b.createElement(a||"div");return this.attr(e,c).css(e,d),e}},g={browser:c,browserVersion:c,transform:c};(function(){var a,b,c=f.node("div"),d=navigator.userAgent,e=["transform","MozTransform","WebkitTransform","OTransform","msTransform"],h=[["webkit",/(webkit)[ \/]([\w.]+)/i],["opera",/(opera)(?:.*version)?[ \/]([\w.]+)/i],["msie",/(msie) ([\w.]+)/i],["mozilla",/(mozilla)(?:.*? rv:([\w.]+))?/i]];for(a=0;a<h.length;a++){b=h[a];if(b[1]=d.match(b[1])){g.browser=b[0],b[1][2]&&(g.browserVersion=parseFloat(b[1][2])||!1);break}}for(a=0;a<e.length;a++){b=e[a];if(b in c.style){g.transform=b;break}}})();var h={prefix:"swift-",source:{"layers-holder":{},"tiles-holder":{"z-index":10},"tiles-layer":{},"vector-holder":{"z-index":100},"marker-holder":{"z-index":1e3}},gen:function(){var a="",b,c,d,e;for(d in this.source){b=[],c=this.source[d];for(e in c)b.push(e+":"+c[e]);a+="."+this.prefix+d+"{"+b.join(";")+";}\n"}return a},get:function(a){return this.source[a]?this.prefix+a:a},init:function(){var a=b.getElementsByTagName("head")[0]||b.body,c=f.node("style",{type:"text/css"}),d=h.gen();c.styleSheet?c.styleSheet.cssText=d:c.appendChild(b.createTextNode(d)),a.appendChild(c)}};h.init(),i.prototype=new Error,j.prototype={on:function(a,b,c){},off:function(a,b){},geo:function(){}},k.prototype={center:function(){return m(this.width()/2,this.height()/2)},height:function(a){return a===c?this.__h:(this.__h=this.valid(a),this)},valid:function(a){a=parseFloat(a);if(isNaN(a))throw i();return a},width:function(a){return a===c?this.__w:(this.__w=this.valid(a),this)}},l.prototype={accuracy:6,minLat:-90,maxLat:90,minLon:-180,maxLon:180,fullTurn:360,distance:function(a){},lon:function(a){return a===c?this.__lon:(a=this.valid(a),a=a%this.fullTurn,a=a<this.minLon?a%this.minLon+this.maxLon:a>this.maxLon?a%this.maxLon+this.minLon:a,this.__lon=a,this)},lat:function(a){return a===c?this.__lat:(a=this.valid(a),a=Math.min(this.maxLat,a),a=Math.max(this.minLat,a),this.__lat=a,this)},toString:function(){return e.tmpl("${__lon}°, ${__lat}°",this)},valid:function(a){a=parseFloat(a);if(isNaN(a))throw i();return parseFloat(a.toFixed(this.accuracy))}},m.prototype={x:function(a){return a===c?this.__x:(this.__x=this.valid(a),this)},y:function(a){return a===c?this.__y:(this.__y=this.valid(a),this)},valid:function(a){a=parseInt(a,10);if(isNaN(a))throw i();return a}},n.prototype={},o.prototype={degToRad:function(a){return a*Math.PI/180},geoToPixel:function(a,b,c){b=parseInt(b);if(a instanceof l&&!isNaN(b)){var d=this.degToRad(a.lon())*this.radius,e=Math.log(Math.tan(Math.PI/4+this.degToRad(a.lat())/2))*this.radius,f=this.resolution(b,c);return m((d+this.halfEquator)/f.width(),(e+this.halfEquator)/f.height())}throw i()},geoToTile:function(a,b,c){return this.pixelToTile(this.geoToPixel(a,b,c),b,c)},normalize:function(a,b){var c=Math.pow(2,b);return a=a%c,a=a<0?c+a:a,a},max:function(a){return Math.pow(2,a)-1},min:function(a){return 0},pixelToGeo:function(a,b,c){b=parseInt(b);if(a instanceof m&&!isNaN(b)){var d=this.resolution(b,c),e=a.x()*d.width()-this.halfEquator,f=a.y()*d.height()-this.halfEquator;return l(this.radToDeg(e/this.radius),this.radToDeg(2*Math.atan(Math.exp(f/this.radius))-Math.PI/2))}throw i()},pixelToTile:function(a,b,c){var d=c||this.tileSize;return n(Math.floor(a.x()/d.width()),Math.pow(2,b)-Math.floor(a.y()/d.height())-1,b,{tpx:(a.x()<0?d.width():0)+a.x()%d.width(),tpy:Math.floor(d.height()-a.y()%d.height()),pixel:a})},radToDeg:function(a){return a*180/Math.PI},resolution:function(a,b){var c=Math.pow(2,a),d=b||this.tileSize;return k(this.equator/d.width()/c,this.equator/d.height()/c)}},p.prototype={prj:function(){return this.__prj||(this.map?this.map.prj():null)},remove:function(){return this._node&&this._node.parentNode?(this._node.parentNode.removeChild(this._node),this.map=null,!0):!1}},e.extend(p,q,{defaultZ:1,defaultTileSize:new k(256,256),rebuild:function(){if(!this.map)return;var a=this.rp(),b=this.prj(),c=this.map.vp(),d=c.center(),e=this.tileSize.width(),f=this.tileSize.height(),g=d.y()-a.tpy,h=d.x()-a.tpx,i=Math.ceil(c.width()/e/2),j=Math.ceil(c.height()/f/2),k=a.tx-i,l=a.tx+i,m=a.ty-j,o=a.ty+j,p,q,r=a.tz,s;m=Math.max(b.min(r),m),o=Math.min(b.max(r),o);for(p=k;p<=l;p++)for(q=m;q<=o;q++)s=n(p,q,r,{tnx:b.normalize(p,r),tny:b.normalize(q,r)}),this._node.appendChild(this.tileNode(s,{position:"absolute",top:g+(q-a.ty)*f+"px",left:h+(p-a.tx)*e+"px"}));a=b=c=d=s=null},rp:function(){return this.map?this.prj().geoToTile(this.map.center(),this.map.zoom()+this.zoomShift,this.tileSize):null},tileNode:function(a,b){return f.node("img",{src:this.url(a.tnx,a.tny,a.tz),width:this.tileSize.width(),height:this.tileSize.height()},b)},update:function(a){e.mixin(this,a||{}),this.url instanceof Function||(this.urltpl=this.url.toString(),this.url=function(a,b,c){return e.tmpl(this.urltpl,{x:a,y:b,z:c})}),e.async(this.rebuild,this)}}),e.extend(j,r,{defaultBackground:"#eee",defaultZoom:10,defaultCenter:l(37.617633,55.755786),minZoom:0,maxZoom:18,add:function(a){if(a instanceof q)return this.__layers.push(a),this._tiles.appendChild(a._node),a.update({map:this}),this;throw i()},bounds:function(a){},center:function(a){if(a===c)return this.__center;if(a instanceof l)return this.__center=a,this;throw i()},empty:function(){var a=this.__layers,b;for(b=0;b<a.length;b++)a[b].remove();return a.length=0,this},prj:function(){return this.__prj},remove:function(){},rp:function(a){return a&&(this.__rp=this.prj().geoToPixel(this.center(),this.zoom())),this.__rp},toString:function(){return"Swift Map"},update:function(a){},vp:function(a){return a&&(this.__vp=k(this._node.offsetWidth,this._node.offsetHeight)),this.__vp},zoom:function(a){if(a===c)return this.__zoom;a=parseInt(a);if(isNaN(a))throw i();return a=Math.min(a,this.maxZoom),a=Math.max(a,this.minZoom),this.__zoom=a,this},zoomIn:function(){},zoomOut:function(){}});var s={EventCover:j,Layer:p,Map:r,Pixel:m,Point:l,ProjectionDefault:o,Size:k,Tile:n,TileLayer:q,utils:e,detect:g,alias:function(b){typeof b=="string"&&(b=a[b]={}),e.each(s,function(a,c){b[a]=c})}};a.swift=s})(window,document);